{"remainingRequest":"D:\\PTUD_Web\\PhamGiaHung_B2111845_CT44901_BaiTapLon\\CTT449-BaiTapLon\\front-end\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\PTUD_Web\\PhamGiaHung_B2111845_CT44901_BaiTapLon\\CTT449-BaiTapLon\\front-end\\src\\components\\books\\EditBook.vue?vue&type=script&lang=js","dependencies":[{"path":"D:\\PTUD_Web\\PhamGiaHung_B2111845_CT44901_BaiTapLon\\CTT449-BaiTapLon\\front-end\\src\\components\\books\\EditBook.vue","mtime":1742722113907},{"path":"D:\\PTUD_Web\\PhamGiaHung_B2111845_CT44901_BaiTapLon\\CTT449-BaiTapLon\\front-end\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1742719098262},{"path":"D:\\PTUD_Web\\PhamGiaHung_B2111845_CT44901_BaiTapLon\\CTT449-BaiTapLon\\front-end\\node_modules\\vue-loader\\lib\\index.js","mtime":1742719098071}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQppbXBvcnQgYXBpIGZyb20gJ0AvYXBpJzsNCmltcG9ydCBhdXRoU2VydmljZSBmcm9tICdAL3NlcnZpY2VzL2F1dGguc2VydmljZSc7DQoNCmV4cG9ydCBkZWZhdWx0IHsNCiAgICBkYXRhKCkgew0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgZm9ybTogew0KICAgICAgICAgICAgICAgIE1hU2FjaDogJycsDQogICAgICAgICAgICAgICAgVGVuU2FjaDogJycsDQogICAgICAgICAgICAgICAgRG9uR2lhOiAwLA0KICAgICAgICAgICAgICAgIFNvUXV5ZW46IDAsDQogICAgICAgICAgICAgICAgTmFtWHVhdEJhbjogMjAyMywNCiAgICAgICAgICAgICAgICBNYU5YQjogJycsDQogICAgICAgICAgICAgICAgVGFjR2lhOiAnJywNCiAgICAgICAgICAgICAgICBIaW5oQW5oOiAnJw0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGZpbGU6IG51bGwNCiAgICAgICAgfTsNCiAgICB9LA0KICAgIGNvbXB1dGVkOiB7DQogICAgICAgIGRpc3BsYXlJbWFnZVVybCgpIHsNCiAgICAgICAgICAgIGlmICh0aGlzLmZvcm0uSGluaEFuaCAmJiB0aGlzLmZvcm0uSGluaEFuaC5zdGFydHNXaXRoKCdodHRwJykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtLkhpbmhBbmg7DQogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuZm9ybS5IaW5oQW5oKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OjMwMDAke3RoaXMuZm9ybS5IaW5oQW5ofWA7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZXR1cm4gJyc7DQogICAgICAgIH0NCiAgICB9LA0KICAgIGFzeW5jIGNyZWF0ZWQoKSB7DQogICAgICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYWRtaW4NCiAgICAgICAgY29uc3QgdXNlciA9IGF1dGhTZXJ2aWNlLmdldEN1cnJlbnRVc2VyKCk7DQogICAgICAgIGlmICghdXNlciB8fCB1c2VyLmNodWN2dSAhPT0gJ2FkbWluJykgew0KICAgICAgICAgICAgYWxlcnQoJ0LhuqFuIGtow7RuZyBjw7MgcXV54buBbiBjaOG7iW5oIHPhu61hIHPDoWNoJyk7DQogICAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL2Jvb2tzJyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICAvLyBHZXQgYm9vayBJRCBmcm9tIHJvdXRlDQogICAgICAgIGNvbnN0IGJvb2tJZCA9IHRoaXMuJHJvdXRlLnBhcmFtcy5pZDsNCiAgICAgICAgaWYgKCFib29rSWQpIHsNCiAgICAgICAgICAgIGFsZXJ0KCdLaMO0bmcgdMOsbSB0aOG6pXkgbcOjIHPDoWNoJyk7DQogICAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL2Jvb2tzJyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgLy8gRmV0Y2ggYm9vayBkZXRhaWxzDQogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFwaS5nZXQoYC9zYWNoP01hU2FjaD0ke2Jvb2tJZH1gKTsNCiAgICAgICAgICAgIGlmICghcmVzcG9uc2UuZGF0YSB8fCByZXNwb25zZS5kYXRhLmxlbmd0aCA9PT0gMCkgew0KICAgICAgICAgICAgICAgIGFsZXJ0KCdLaMO0bmcgdMOsbSB0aOG6pXkgdGjDtG5nIHRpbiBzw6FjaCcpOw0KICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKCcvYm9va3MnKTsNCiAgICAgICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGNvbnN0IGJvb2sgPSByZXNwb25zZS5kYXRhWzBdOw0KICAgICAgICAgICAgdGhpcy5mb3JtID0gew0KICAgICAgICAgICAgICAgIE1hU2FjaDogYm9vay5NYVNhY2gsDQogICAgICAgICAgICAgICAgVGVuU2FjaDogYm9vay5UZW5TYWNoLA0KICAgICAgICAgICAgICAgIERvbkdpYTogYm9vay5Eb25HaWEgfHwgMCwNCiAgICAgICAgICAgICAgICBTb1F1eWVuOiBib29rLlNvUXV5ZW4gfHwgMCwNCiAgICAgICAgICAgICAgICBOYW1YdWF0QmFuOiBib29rLk5hbVh1YXRCYW4gfHwgbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpLA0KICAgICAgICAgICAgICAgIE1hTlhCOiBib29rLk1hTlhCIHx8ICcnLA0KICAgICAgICAgICAgICAgIFRhY0dpYTogYm9vay5UYWNHaWEgfHwgJycsDQogICAgICAgICAgICAgICAgSGluaEFuaDogYm9vay5IaW5oQW5oIHx8ICcnDQogICAgICAgICAgICB9Ow0KICAgICAgICB9IGNhdGNoIChlcnIpIHsNCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGJvb2sgZGV0YWlsczonLCBlcnIpOw0KICAgICAgICAgICAgYWxlcnQoJ0tow7RuZyB0aOG7gyB04bqjaSB0aMO0bmcgdGluIHPDoWNoJyk7DQogICAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL2Jvb2tzJyk7DQogICAgICAgIH0NCiAgICB9LA0KICAgIG1ldGhvZHM6IHsNCiAgICAgICAgaGFuZGxlRmlsZShlKSB7DQogICAgICAgICAgICB0aGlzLmZpbGUgPSBlLnRhcmdldC5maWxlc1swXTsNCiAgICAgICAgfSwNCiAgICAgICAgYXN5bmMgdXBkYXRlQm9vaygpIHsNCiAgICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgICAgLy8gQ2hlY2sgcmVxdWlyZWQgZmllbGRzDQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLmZvcm0uTWFTYWNoIHx8ICF0aGlzLmZvcm0uVGVuU2FjaCB8fCAhdGhpcy5mb3JtLk1hTlhCKSB7DQogICAgICAgICAgICAgICAgICAgIGFsZXJ0KCdWdWkgbMOybmcgxJFp4buBbiDEkeG6p3kgxJHhu6cgY8OhYyB0csaw4budbmcgYuG6r3QgYnXhu5ljOiBNw6Mgc8OhY2gsIFTDqm4gc8OhY2gsIE3DoyBOWEInKTsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIElmIHdlIGhhdmUgYSBmaWxlLCB1c2UgRm9ybURhdGEsIG90aGVyd2lzZSBzZW5kIEpTT04NCiAgICAgICAgICAgICAgICBpZiAodGhpcy5maWxlKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7DQogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuZm9ybSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2tpcCBIaW5oQW5oIHdoZW4gdXBsb2FkaW5nIGEgbmV3IGZpbGUNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdIaW5oQW5oJyAmJiB0aGlzLmZpbGUpIGNvbnRpbnVlOw0KICAgICAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgICAgICAvLyBFbnN1cmUgbnVtYmVycyBhcmUgcHJvcGVybHkgaGFuZGxlZA0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKFsnRG9uR2lhJywgJ1NvUXV5ZW4nLCAnTmFtWHVhdEJhbiddLmluY2x1ZGVzKGtleSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YS5hcHBlbmQoa2V5LCBOdW1iZXIodGhpcy5mb3JtW2tleV0pKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKGtleSwgdGhpcy5mb3JtW2tleV0pOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnSGluaEFuaCcsIHRoaXMuZmlsZSk7DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBhcGkucHV0KGAvc2FjaC8ke3RoaXMuZm9ybS5NYVNhY2h9YCwgZm9ybURhdGEsIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJyB9DQogICAgICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgc3RyaW5nIG51bWJlcnMgdG8gYWN0dWFsIG51bWJlcnMNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9ybURhdGEgPSB7DQogICAgICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmZvcm0sDQogICAgICAgICAgICAgICAgICAgICAgICBEb25HaWE6IE51bWJlcih0aGlzLmZvcm0uRG9uR2lhKSwNCiAgICAgICAgICAgICAgICAgICAgICAgIFNvUXV5ZW46IE51bWJlcih0aGlzLmZvcm0uU29RdXllbiksDQogICAgICAgICAgICAgICAgICAgICAgICBOYW1YdWF0QmFuOiBOdW1iZXIodGhpcy5mb3JtLk5hbVh1YXRCYW4pDQogICAgICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICAgICBhd2FpdCBhcGkucHV0KGAvc2FjaC8ke3RoaXMuZm9ybS5NYVNhY2h9YCwgZm9ybURhdGEpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBhbGVydCgnQ+G6rXAgbmjhuq10IHPDoWNoIHRow6BuaCBjw7RuZycpOw0KICAgICAgICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKCcvYm9va3MnKTsNCiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGJvb2s6JywgZXJyKTsNCiAgICAgICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gJ0Phuq1wIG5o4bqtdCBzw6FjaCB0aOG6pXQgYuG6oWknOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGlmIChlcnIucmVzcG9uc2UpIHsNCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHJlc3BvbnNlOicsIGVyci5yZXNwb25zZS5kYXRhKTsNCiAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlICs9ICc6ICcgKyAoZXJyLnJlc3BvbnNlLmRhdGEubWVzc2FnZSB8fCBlcnIucmVzcG9uc2Uuc3RhdHVzVGV4dCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgIGFsZXJ0KGVycm9yTWVzc2FnZSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQp9Ow0K"},{"version":3,"sources":["EditBook.vue"],"names":[],"mappings":";AA0CA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA","file":"EditBook.vue","sourceRoot":"src/components/books","sourcesContent":["<template>\r\n    <b-container>\r\n        <h2>Sửa thông tin sách</h2>\r\n        <b-form @submit.prevent=\"updateBook\">\r\n            <b-form-group label=\"Mã sách\">\r\n                <b-form-input v-model=\"form.MaSach\" required disabled />\r\n            </b-form-group>\r\n            <b-form-group label=\"Tên sách\">\r\n                <b-form-input v-model=\"form.TenSach\" required />\r\n            </b-form-group>\r\n            <b-form-group label=\"Đơn giá\">\r\n                <b-form-input type=\"number\" v-model.number=\"form.DonGia\" />\r\n            </b-form-group>\r\n            <b-form-group label=\"Số quyển\">\r\n                <b-form-input type=\"number\" v-model.number=\"form.SoQuyen\" />\r\n            </b-form-group>\r\n            <b-form-group label=\"Năm xuất bản\">\r\n                <b-form-input type=\"number\" v-model.number=\"form.NamXuatBan\" />\r\n            </b-form-group>\r\n            <b-form-group label=\"Mã NXB\">\r\n                <b-form-input v-model=\"form.MaNXB\" required />\r\n            </b-form-group>\r\n            <b-form-group label=\"Tác giả\">\r\n                <b-form-input v-model=\"form.TacGia\" />\r\n            </b-form-group>\r\n            <b-form-group label=\"Hình ảnh (URL)\">\r\n                <b-form-input v-model=\"form.HinhAnh\" placeholder=\"Nhập URL hoặc để trống\" />\r\n            </b-form-group>\r\n            <b-form-group label=\"Upload file mới\">\r\n                <b-form-file @change=\"handleFile\" />\r\n            </b-form-group>\r\n            <div v-if=\"form.HinhAnh\" class=\"mb-3\">\r\n                <p>Hình ảnh hiện tại:</p>\r\n                <img :src=\"displayImageUrl\" alt=\"Book cover\" style=\"max-height: 150px;\" />\r\n            </div>\r\n            <b-button type=\"submit\" variant=\"primary\">Cập nhật sách</b-button>\r\n            <b-button variant=\"secondary\" class=\"ml-2\" @click=\"$router.push('/books')\">Huỷ</b-button>\r\n        </b-form>\r\n    </b-container>\r\n</template>\r\n\r\n<script>\r\nimport api from '@/api';\r\nimport authService from '@/services/auth.service';\r\n\r\nexport default {\r\n    data() {\r\n        return {\r\n            form: {\r\n                MaSach: '',\r\n                TenSach: '',\r\n                DonGia: 0,\r\n                SoQuyen: 0,\r\n                NamXuatBan: 2023,\r\n                MaNXB: '',\r\n                TacGia: '',\r\n                HinhAnh: ''\r\n            },\r\n            file: null\r\n        };\r\n    },\r\n    computed: {\r\n        displayImageUrl() {\r\n            if (this.form.HinhAnh && this.form.HinhAnh.startsWith('http')) {\r\n                return this.form.HinhAnh;\r\n            } else if (this.form.HinhAnh) {\r\n                return `http://localhost:3000${this.form.HinhAnh}`;\r\n            }\r\n            return '';\r\n        }\r\n    },\r\n    async created() {\r\n        // Check if user is admin\r\n        const user = authService.getCurrentUser();\r\n        if (!user || user.chucvu !== 'admin') {\r\n            alert('Bạn không có quyền chỉnh sửa sách');\r\n            this.$router.push('/books');\r\n            return;\r\n        }\r\n\r\n        // Get book ID from route\r\n        const bookId = this.$route.params.id;\r\n        if (!bookId) {\r\n            alert('Không tìm thấy mã sách');\r\n            this.$router.push('/books');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            // Fetch book details\r\n            const response = await api.get(`/sach?MaSach=${bookId}`);\r\n            if (!response.data || response.data.length === 0) {\r\n                alert('Không tìm thấy thông tin sách');\r\n                this.$router.push('/books');\r\n                return;\r\n            }\r\n\r\n            const book = response.data[0];\r\n            this.form = {\r\n                MaSach: book.MaSach,\r\n                TenSach: book.TenSach,\r\n                DonGia: book.DonGia || 0,\r\n                SoQuyen: book.SoQuyen || 0,\r\n                NamXuatBan: book.NamXuatBan || new Date().getFullYear(),\r\n                MaNXB: book.MaNXB || '',\r\n                TacGia: book.TacGia || '',\r\n                HinhAnh: book.HinhAnh || ''\r\n            };\r\n        } catch (err) {\r\n            console.error('Error fetching book details:', err);\r\n            alert('Không thể tải thông tin sách');\r\n            this.$router.push('/books');\r\n        }\r\n    },\r\n    methods: {\r\n        handleFile(e) {\r\n            this.file = e.target.files[0];\r\n        },\r\n        async updateBook() {\r\n            try {\r\n                // Check required fields\r\n                if (!this.form.MaSach || !this.form.TenSach || !this.form.MaNXB) {\r\n                    alert('Vui lòng điền đầy đủ các trường bắt buộc: Mã sách, Tên sách, Mã NXB');\r\n                    return;\r\n                }\r\n\r\n                // If we have a file, use FormData, otherwise send JSON\r\n                if (this.file) {\r\n                    const formData = new FormData();\r\n                    for (const key in this.form) {\r\n                        // Skip HinhAnh when uploading a new file\r\n                        if (key === 'HinhAnh' && this.file) continue;\r\n                        \r\n                        // Ensure numbers are properly handled\r\n                        if (['DonGia', 'SoQuyen', 'NamXuatBan'].includes(key)) {\r\n                            formData.append(key, Number(this.form[key]));\r\n                        } else {\r\n                            formData.append(key, this.form[key]);\r\n                        }\r\n                    }\r\n                    formData.append('HinhAnh', this.file);\r\n                    \r\n                    await api.put(`/sach/${this.form.MaSach}`, formData, {\r\n                        headers: { 'Content-Type': 'multipart/form-data' }\r\n                    });\r\n                } else {\r\n                    // Convert string numbers to actual numbers\r\n                    const formData = {\r\n                        ...this.form,\r\n                        DonGia: Number(this.form.DonGia),\r\n                        SoQuyen: Number(this.form.SoQuyen),\r\n                        NamXuatBan: Number(this.form.NamXuatBan)\r\n                    };\r\n                    \r\n                    await api.put(`/sach/${this.form.MaSach}`, formData);\r\n                }\r\n                \r\n                alert('Cập nhật sách thành công');\r\n                this.$router.push('/books');\r\n            } catch (err) {\r\n                console.error('Error updating book:', err);\r\n                let errorMessage = 'Cập nhật sách thất bại';\r\n                \r\n                if (err.response) {\r\n                    console.log('Error response:', err.response.data);\r\n                    errorMessage += ': ' + (err.response.data.message || err.response.statusText);\r\n                }\r\n                \r\n                alert(errorMessage);\r\n            }\r\n        }\r\n    }\r\n};\r\n</script>\r\n"]}]}